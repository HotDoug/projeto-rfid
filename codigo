#include <SPI.h>                 // Inclui a biblioteca SPI
#include <RFID.h>                // Inclui a biblioteca do RFID RC522
#include <Wire.h>                // Inclui a biblioteca Wire
#include <LiquidCrystal.h>       // Inclui a biblioteca do display 16x2
#include <Servo.h>               // Inclui a biblioteca do Servo Motor SG90

#define SS_PIN 10                       // Define o pino SS do RFID
#define RST_PIN 9                       // Define o pino Reset do RFID

RFID rfid(SS_PIN, RST_PIN);             //Iniciliza as configurações da biblioteca RFID

LiquidCrystal lcd(6, 7, 5, 4, 3, 2);    // Declara os pinos do display

const int ServoMotor = 8;
Servo s;
int pos;

int serNum[5];                          // Variável de leitura da tag

int cards[][5] = {                      // Declara os códigos liberados para acesso
  {118, 157, 177, 171, 241},            // Tag de Acesso 1            // Tag de Acesso 2
  {55, 121, 5, 216, 147}               
};

bool access = false;

int alarm = 0;
uint8_t alarmStat = 0;
uint8_t maxError = 5;

void setup() {
  Serial.begin(9600);
  lcd.begin(16, 2);
  SPI.begin();
  rfid.init();

  s.attach(ServoMotor);
  s.write(0);


  lcd.setCursor (0, 0);
  lcd.print(F("   Iniciando"));
  lcd.setCursor (0, 1);
  lcd.print(F("    sistema"));
  delay (3000);
  lcd.clear();
}

void loop() {
  if (alarm >= maxError) {
    alarmStat = 1;
  }

  if (alarmStat == 0) {
    lcd.setCursor (0, 0);
    lcd.print(F("Ola, tudo bem?"));
    lcd.setCursor (0, 1);
    lcd.print(F("Aguardando RFID "));

    if (rfid.isCard()) {

      if (rfid.readCardSerial()) {
        Serial.print(rfid.serNum[0]);
        Serial.print(" ");
        Serial.print(rfid.serNum[1]);
        Serial.print(" ");
        Serial.print(rfid.serNum[2]);
        Serial.print(" ");
        Serial.print(rfid.serNum[3]);
        Serial.print(" ");
        Serial.print(rfid.serNum[4]);
        Serial.println("");

        for (int x = 0; x < sizeof(cards); x++) {
          for (int i = 0; i < sizeof(rfid.serNum); i++ ) {
            if (rfid.serNum[i] != cards[x][i]) {
              access = false;
              break;
            } else {
              access = true;
            }
          }
          if (access) break;
        }
      }

      if (access) {
        Serial.println("Bem-vindo(a)!");
        lcd.print(rfid.serNum[0]); lcd.print(rfid.serNum[1]);
        lcd.print(rfid.serNum[2]); lcd.print(rfid.serNum[3]);
        lcd.print(rfid.serNum[4]);
        for(pos = 0; pos < 90; pos++);
        s.write(pos);
        lcd.setCursor (0, 0);
        lcd.print(F(" Bem-vindo(a)! "));
        lcd.setCursor (0, 1);
        lcd.print(F("                "));
        for (int i = 5; i > 0; i--) {
          lcd.setCursor (8, 1); lcd.print(i);
          delay (1000);
        }
        for(pos = 90; pos >= 0; pos--);
        s.write(pos); 
        lcd.clear();
      }
      else {
        alarm = alarm + 1;
        Serial.println("Acesso Negado");
        lcd.print(rfid.serNum[0]); lcd.print(rfid.serNum[1]);
        lcd.print(rfid.serNum[2]); lcd.print(rfid.serNum[3]);
        lcd.print(rfid.serNum[4]);
           lcd.clear();
      }
    }
    rfid.halt();
  }
  else {
    lcd.setCursor (0, 0);
    lcd.print(F(" Acesso Negado "));
    lcd.setCursor (0, 1);
    lcd.print(F(" "));
    for (int i = 8; i > 0; i--) {
      lcd.setCursor (7, 1); lcd.print(i);
      lcd.print(F("               ")); 
      delay (1000);
    }
    alarmStat = 0;
    alarm = 0;
  }
}
